<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VALUENEX Office Map Editor</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            display: flex;
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .map-container {
            flex: 1;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            position: relative;
        }
        
        #canvas-container {
            position: relative;
            overflow: auto;
            max-height: 80vh;
        }
        
        canvas {
            cursor: crosshair;
            display: block;
        }
        
        h1 {
            margin: 0 0 20px 0;
            color: #333;
        }
        
        h2 {
            font-size: 18px;
            color: #555;
            margin-top: 20px;
            margin-bottom: 10px;
        }
        
        .mode-selector {
            margin-bottom: 20px;
        }
        
        .mode-selector label {
            display: block;
            margin: 5px 0;
            cursor: pointer;
        }
        
        .location-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .location-item {
            padding: 8px;
            margin: 5px 0;
            background: #f9f9f9;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .location-item:hover {
            background: #e9e9e9;
        }
        
        .location-item.selected {
            background: #d0e8ff;
            border: 1px solid #4a90e2;
        }
        
        .delete-btn {
            background: #ff4444;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        .delete-btn:hover {
            background: #cc0000;
        }
        
        button {
            background: #4a90e2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
            width: calc(100% - 10px);
        }
        
        button:hover {
            background: #357abd;
        }
        
        .navigation-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ddd;
        }
        
        select {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .status-bar {
            background: #333;
            color: white;
            padding: 10px 20px;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            font-size: 14px;
        }
        
        .path-info {
            background: #e8f4fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            color: #2c5282;
        }
        
        #coordinate-display {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
        }
    </style>
</head>
<body>
    <h1>üó∫Ô∏è VALUENEX Office Map Editor</h1>
    
    <div class="container">
        <div class="sidebar">
            <div class="mode-selector">
                <h2>Mode</h2>
                <label>
                    <input type="radio" name="mode" value="add" checked>
                    üìç Add Location
                </label>
                <label>
                    <input type="radio" name="mode" value="navigate">
                    üß≠ Navigate
                </label>
                <label>
                    <input type="radio" name="mode" value="view">
                    üëÅÔ∏è View Only
                </label>
            </div>
            
            <h2>Locations</h2>
            <ul id="location-list" class="location-list"></ul>
            
            <button onclick="saveLocations()">üíæ Save All Locations</button>
            <button onclick="loadLocations()">üîÑ Reload Locations</button>
            <button onclick="exportJSON()">üì• Export JSON</button>
            
            <div class="navigation-section">
                <h2>Navigation</h2>
                <label>From:</label>
                <select id="from-select">
                    <option value="">Select start...</option>
                </select>
                
                <label>To:</label>
                <select id="to-select">
                    <option value="">Select destination...</option>
                </select>
                
                <button onclick="findPath()">üöÄ Find Path</button>
                <button onclick="clearPath()">‚ùå Clear Path</button>
                
                <div id="path-info" class="path-info" style="display: none;"></div>
            </div>
        </div>
        
        <div class="map-container">
            <div id="coordinate-display">Click to add location</div>
            <div id="canvas-container">
                <canvas id="map-canvas"></canvas>
            </div>
        </div>
    </div>
    
    <div class="status-bar" id="status-bar">Ready</div>
    
    <script>
        const canvas = document.getElementById('map-canvas');
        const ctx = canvas.getContext('2d');
        const canvasContainer = document.getElementById('canvas-container');
        
        // Configuration
        const config = {
            image: 'VNX_BW_Floorplan_Updated.PNG',
            resolution: 0.005,  // 5mm per pixel
            widthMeters: 5.71,
            heightMeters: 23.19
        };
        
        let locations = {};
        let selectedLocation = null;
        let currentPath = null;
        let mapImage = null;
        let mode = 'add';
        
        // Load map image
        const img = new Image();
        img.onload = function() {
            mapImage = img;
            canvas.width = img.width;
            canvas.height = img.height;
            redrawCanvas();
            loadLocations();
        };
        img.src = config.image;
        
        // Mode selection
        document.querySelectorAll('input[name="mode"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                mode = e.target.value;
                updateStatus(`Mode: ${mode}`);
                updateCursor();
            });
        });
        
        function updateCursor() {
            if (mode === 'add') {
                canvas.style.cursor = 'crosshair';
            } else if (mode === 'navigate') {
                canvas.style.cursor = 'pointer';
            } else {
                canvas.style.cursor = 'default';
            }
        }
        
        // Canvas events
        canvas.addEventListener('click', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left + canvasContainer.scrollLeft;
            const y = e.clientY - rect.top + canvasContainer.scrollTop;
            
            if (mode === 'add') {
                addLocation(x, y);
            } else if (mode === 'navigate') {
                selectNearestLocation(x, y);
            }
        });
        
        canvas.addEventListener('mousemove', (e) => {
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left + canvasContainer.scrollLeft;
            const y = e.clientY - rect.top + canvasContainer.scrollTop;
            
            const xMeters = (x * config.resolution).toFixed(2);
            const yMeters = (y * config.resolution).toFixed(2);
            
            document.getElementById('coordinate-display').textContent = 
                `Position: (${xMeters}m, ${yMeters}m)`;
        });
        
        function addLocation(x, y) {
            const name = prompt('Enter location name (e.g., "kitchen", "desk_1"):');
            if (!name) return;
            
            if (locations[name]) {
                if (!confirm(`Location "${name}" already exists. Overwrite?`)) {
                    return;
                }
            }
            
            const xMeters = x * config.resolution;
            const yMeters = y * config.resolution;
            
            locations[name] = {
                x: parseFloat(xMeters.toFixed(2)),
                y: parseFloat(yMeters.toFixed(2)),
                description: `Added via web editor`
            };
            
            updateLocationList();
            redrawCanvas();
            updateStatus(`Added location: ${name}`);
        }
        
        function deleteLocation(name) {
            if (confirm(`Delete location "${name}"?`)) {
                delete locations[name];
                updateLocationList();
                redrawCanvas();
                updateStatus(`Deleted location: ${name}`);
            }
        }
        
        function updateLocationList() {
            const list = document.getElementById('location-list');
            const fromSelect = document.getElementById('from-select');
            const toSelect = document.getElementById('to-select');
            
            list.innerHTML = '';
            fromSelect.innerHTML = '<option value="">Select start...</option>';
            toSelect.innerHTML = '<option value="">Select destination...</option>';
            
            Object.keys(locations).sort().forEach(name => {
                const loc = locations[name];
                
                // List item
                const li = document.createElement('li');
                li.className = 'location-item';
                li.innerHTML = `
                    <span>${name} (${loc.x}m, ${loc.y}m)</span>
                    <button class="delete-btn" onclick="deleteLocation('${name}')">Delete</button>
                `;
                li.onclick = (e) => {
                    if (!e.target.classList.contains('delete-btn')) {
                        selectLocation(name);
                    }
                };
                list.appendChild(li);
                
                // Select options
                const option1 = document.createElement('option');
                option1.value = name;
                option1.textContent = name;
                fromSelect.appendChild(option1);
                
                const option2 = document.createElement('option');
                option2.value = name;
                option2.textContent = name;
                toSelect.appendChild(option2);
            });
        }
        
        function selectLocation(name) {
            selectedLocation = name;
            document.querySelectorAll('.location-item').forEach(item => {
                item.classList.remove('selected');
                if (item.textContent.includes(name)) {
                    item.classList.add('selected');
                }
            });
            redrawCanvas();
        }
        
        function selectNearestLocation(x, y) {
            let nearest = null;
            let minDist = Infinity;
            
            Object.entries(locations).forEach(([name, loc]) => {
                const locX = loc.x / config.resolution;
                const locY = loc.y / config.resolution;
                const dist = Math.sqrt((x - locX) ** 2 + (y - locY) ** 2);
                
                if (dist < minDist && dist < 30) {  // Within 30 pixels
                    minDist = dist;
                    nearest = name;
                }
            });
            
            if (nearest) {
                const fromSelect = document.getElementById('from-select');
                const toSelect = document.getElementById('to-select');
                
                if (!fromSelect.value) {
                    fromSelect.value = nearest;
                    updateStatus(`Start: ${nearest}`);
                } else if (!toSelect.value) {
                    toSelect.value = nearest;
                    updateStatus(`Destination: ${nearest}`);
                    findPath();
                }
            }
        }
        
        function redrawCanvas() {
            if (!mapImage) return;
            
            // Clear and draw map
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(mapImage, 0, 0);
            
            // Draw path if exists
            if (currentPath && currentPath.length > 1) {
                ctx.strokeStyle = 'blue';
                ctx.lineWidth = 3;
                ctx.beginPath();
                ctx.moveTo(currentPath[0][0], currentPath[0][1]);
                for (let i = 1; i < currentPath.length; i++) {
                    ctx.lineTo(currentPath[i][0], currentPath[i][1]);
                }
                ctx.stroke();
            }
            
            // Draw locations
            Object.entries(locations).forEach(([name, loc]) => {
                const x = loc.x / config.resolution;
                const y = loc.y / config.resolution;
                
                // Draw marker
                ctx.fillStyle = selectedLocation === name ? 'green' : 'red';
                ctx.strokeStyle = 'darkred';
                ctx.lineWidth = 2;
                ctx.beginPath();
                ctx.arc(x, y, 6, 0, 2 * Math.PI);
                ctx.fill();
                ctx.stroke();
                
                // Draw label
                ctx.fillStyle = 'darkblue';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(name, x, y - 10);
            });
        }
        
        function saveLocations() {
            localStorage.setItem('office_locations', JSON.stringify(locations));
            updateStatus('Locations saved to browser storage');
            
            // Also save to file (create download link)
            const dataStr = JSON.stringify(locations, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
            
            const exportAnchor = document.createElement('a');
            exportAnchor.setAttribute('href', dataUri);
            exportAnchor.setAttribute('download', 'office_locations_updated.json');
            exportAnchor.click();
        }
        
        function loadLocations() {
            const saved = localStorage.getItem('office_locations');
            if (saved) {
                locations = JSON.parse(saved);
                updateLocationList();
                redrawCanvas();
                updateStatus('Locations loaded from browser storage');
            }
        }
        
        function exportJSON() {
            const dataStr = JSON.stringify(locations, null, 2);
            const blob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'office_locations_updated.json';
            a.click();
            URL.revokeObjectURL(url);
            updateStatus('JSON exported');
        }
        
        function findPath() {
            const from = document.getElementById('from-select').value;
            const to = document.getElementById('to-select').value;
            
            if (!from || !to) {
                alert('Please select both start and destination locations');
                return;
            }
            
            // For demonstration, create a simple straight line path
            // In production, this would call the Python A* algorithm
            const fromLoc = locations[from];
            const toLoc = locations[to];
            
            if (!fromLoc || !toLoc) {
                alert('Invalid locations selected');
                return;
            }
            
            const fromX = fromLoc.x / config.resolution;
            const fromY = fromLoc.y / config.resolution;
            const toX = toLoc.x / config.resolution;
            const toY = toLoc.y / config.resolution;
            
            // Create simple path (in real app, use A*)
            currentPath = [];
            const steps = 50;
            for (let i = 0; i <= steps; i++) {
                const t = i / steps;
                currentPath.push([
                    fromX + (toX - fromX) * t,
                    fromY + (toY - fromY) * t
                ]);
            }
            
            const distance = Math.sqrt((toLoc.x - fromLoc.x) ** 2 + (toLoc.y - fromLoc.y) ** 2);
            
            const pathInfo = document.getElementById('path-info');
            pathInfo.style.display = 'block';
            pathInfo.innerHTML = `
                <strong>Path Found!</strong><br>
                From: ${from}<br>
                To: ${to}<br>
                Distance: ${distance.toFixed(2)}m<br>
                <small>Note: Using straight-line path for demo. Connect to Python backend for A* pathfinding.</small>
            `;
            
            redrawCanvas();
            updateStatus(`Path found: ${distance.toFixed(2)}m`);
        }
        
        function clearPath() {
            currentPath = null;
            document.getElementById('from-select').value = '';
            document.getElementById('to-select').value = '';
            document.getElementById('path-info').style.display = 'none';
            redrawCanvas();
            updateStatus('Path cleared');
        }
        
        function updateStatus(message) {
            document.getElementById('status-bar').textContent = message;
        }
        
        // Initial load
        loadLocations();
    </script>
</body>
</html>